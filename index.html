<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교통카드 잔액 조회기</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        #status { margin: 20px; font-size: 18px; }
        #balance { font-size: 24px; font-weight: bold; color: green; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>교통카드 잔액 조회</h1>
    <button id="scanButton">카드 스캔</button>
    <div id="status">카드를 스캔해주세요.</div>
    <div id="balance"></div>

    <script>
        const scanButton = document.getElementById('scanButton');
        const statusDiv = document.getElementById('status');
        const balanceDiv = document.getElementById('balance');

        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return bytes;
        }

        function bytesToHex(bytes) {
            return Array.from(bytes)
                .map(byte => byte.toString(16).padStart(2, '0'))
                .join('');
        }

        function bytesToBalance(bytes) {
            return (bytes[0] << 24) | (bytes[1] << 16) | (bytes[2] << 8) | bytes[3];
        }

        async function scanCard() {
            if (!('NDEFReader' in window)) {
                statusDiv.textContent = 'Web NFC를 지원하지 않는 브라우저입니다.';
                return;
            }

            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                statusDiv.textContent = '카드를 스캔 중입니다...';

                ndef.onreading = async ({ serialNumber }) => {
                    statusDiv.textContent = `카드 감지됨: ${serialNumber}`;
                    try {
                        const nfc = new NFCReader();
                        const isoDep = await nfc.connect({ technology: 'IsoDep' });

                        const selectFileApdu = hexToBytes('00A4040007D410000003000100');
                        let response = await isoDep.transceive(selectFileApdu);
                        const sw = bytesToHex(response.slice(-2));
                        if (sw !== '9000') {
                            throw new Error(`SELECT FILE 실패: SW=${sw}`);
                        }

                        const balanceApdu = hexToBytes('904C000004');
                        response = await isoDep.transceive(balanceApdu);
                        const balanceBytes = response.slice(0, 4);
                        const balance = bytesToBalance(balanceBytes);

                        statusDiv.textContent = '잔액 조회 완료!';
                        balanceDiv.textContent = `잔액: ${balance}원`;
                    } catch (error) {
                        statusDiv.textContent = `오류: ${error.message}`;
                    } finally {
                        await isoDep.close();
                    }
                };

                ndef.onreadingerror = () => {
                    statusDiv.textContent = '카드 읽기 실패. 다시 시도하세요.';
                };
            } catch (error) {
                statusDiv.textContent = `NFC 스캔 오류: ${error.message}`;
            }
        }

        scanButton.addEventListener('click', scanCard);
    </script>
</body>
</html>
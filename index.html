<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교통카드 잔액 조회기</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        #status { margin: 20px; font-size: 18px; }
        #tagInfo { margin: 10px; font-size: 16px; color: #333; }
        #balance { font-size: 24px; font-weight: bold; color: green; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        pre { text-align: left; margin: 10px auto; padding: 10px; background: #f5f5f5; max-width: 90%; }
    </style>
</head>
<body>
    <h1>교통카드 잔액 조회</h1>
    <button id="scanButton">카드 스캔</button>
    <div id="status">카드를 스캔해주세요.</div>
    <div id="tagInfo"></div>
    <div id="balance"></div>

    <script>
        const scanButton = document.getElementById('scanButton');
        const statusDiv = document.getElementById('status');
        const tagInfoDiv = document.getElementById('tagInfo');
        const balanceDiv = document.getElementById('balance');

        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return bytes;
        }

        function bytesToHex(bytes) {
            return Array.from(bytes)
                .map(byte => byte.toString(16).padStart(2, '0'))
                .join('');
        }

        function bytesToBalance(bytes) {
            if (bytes.length !== 4) return -1;
            const balance = (bytes[0] << 24) | (bytes[1] << 16) | (bytes[2] << 8) | bytes[3];
            return balance >= 0 && balance <= 1000000 ? balance : -1;
        }

        const cardConfigs = {
            tmoney: { selectFile: hexToBytes('00A4040007D410000003000100'), balance: hexToBytes('904C000004') },
            cashbee: { selectFile: hexToBytes('00A4040007D410000003000100'), balance: hexToBytes('904C000004') },
            hipass: { selectFile: hexToBytes('00A4040007A000000632010105'), balance: hexToBytes('905C000004') },
            master: { selectFile: hexToBytes('00A4040007D410000003000100'), balance: hexToBytes('904C000004') },
            hanpay: { selectFile: hexToBytes('00A4040007D410000003000100'), balance: hexToBytes('904C000004') }
        };

        let currentCardType = 'tmoney';

        async function scanCard() {
            if (!('NDEFReader' in window)) {
                statusDiv.textContent = 'Web NFC를 지원하지 않는 브라우저입니다.';
                return;
            }

            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                statusDiv.textContent = '카드를 스캔 중입니다...';

                ndef.onreading = async (event) => {
                    // NFC 태그 시점의 데이터를 화면에 표시
                    const tagData = {
                        serialNumber: event.serialNumber,
                        message: event.message ? event.message.records.map(r => ({
                            recordType: r.recordType,
                            id: bytesToHex(r.id || []),
                            data: bytesToHex(r.data || [])
                        })) : 'No NDEF message'
                    };
                    tagInfoDiv.innerHTML = `<pre>${JSON.stringify(tagData, null, 2)}</pre>`;
                    statusDiv.textContent = `카드 감지됨: ${event.serialNumber}`;
                    try {
                        const nfc = new NFCReader();
                        const isoDep = await nfc.connect({ technology: 'IsoDep' });

                        const config = cardConfigs[currentCardType];
                        let response = await isoDep.transceive(config.selectFile);
                        const sw = bytesToHex(response.slice(-2));
                        if (sw !== '9000') {
                            throw new Error(`SELECT FILE 실패: SW=${sw}, 카드 유형 확인 필요`);
                        }

                        response = await isoDep.transceive(config.balance);
                        const balanceBytes = response.slice(0, 4);
                        const balance = bytesToBalance(balanceBytes);
                        if (balance < 0) {
                            throw new Error("잔액 데이터가 비정상적 또는 4바이트 아님");
                        }

                        statusDiv.textContent = '잔액 조회 완료!';
                        balanceDiv.textContent = `잔액: ${balance}원`;
                    } catch (error) {
                        statusDiv.textContent = `오류: ${error.message}`;
                    } finally {
                        await isoDep.close();
                    }
                };

                ndef.onreadingerror = () => {
                    statusDiv.textContent = '카드 읽기 실패. 다시 시도하세요.';
                    tagInfoDiv.innerHTML = '<pre>읽기 오류 발생. NFC 태그 데이터를 확인하세요.</pre>';
                };
            } catch (error) {
                statusDiv.textContent = `NFC 스캔 오류: ${error.message}`;
                tagInfoDiv.innerHTML = `<pre>스캔 오류: ${error.message}</pre>`;
            }
        }

        scanButton.addEventListener('click', scanCard);
    </script>
</body>
</html>
